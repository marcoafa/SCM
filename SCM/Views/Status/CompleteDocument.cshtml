@using SCM.ViewModel;
@model DataDocumentVM;

@{
    ViewData["Title"] = "Document";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<section class="Document">
    <div class="divHeader">

        <h2 style="color: white;" class="text-center">Favor de completar el manifiesto</h2>


    </div>
   

    <!--NUMBER OF THE DOCUMENT-->
    <div class="form-group row">
        <label class="control-label col-sm-2 offset-md-2" for="CustomerValC">No. Manifiesto:</label>
        <div class="col-sm-6 input-group">

            <div class="input-group-append">
                <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
            </div>
            <input disabled value="@Model.DocumentD.DocumentID" type="number" min="0" class="form-control" id="ManifiestoValC" placeholder="Agregar el numero del Manifiesto">
        </div>
    </div>
    <!--CUSTOMER-->
    <div class="form-group row">
        <label class="control-label col-sm-2 offset-md-2" for="CustomerValC">Cliente:</label>
        <div class="col-sm-6 input-group">

            <div class="input-group-append">
                <span class="input-group-text"><i class="fas fa-address-book"></i></span>
            </div>
            <input disabled value="@Model.DocumentD.Customer" class="form-control">
        </div>
    </div>

    <!--EMPLOYEE-->
    <div class="form-group row">
        <label class="control-label col-sm-2 offset-md-2" for="CustomerValC">Empleado:</label>
        <div class="col-sm-6 input-group">

            <div class="input-group-append">
                <span class="input-group-text"><i class="fas fa-user"></i></span>
            </div>

            <input disabled value="@Model.DocumentD.Username" type="text" class="form-control">
        </div>
    </div>


    <section class="DocumentFormOptional" margin-top:10px;">

        <!--ADD PRODUCTS-->
        <div class="form-group row">
            <label for="EmployeeValC" class="col-sm-2 offset-md-2 col-form-label">Agregar Productos</label>

            <div class="col-md-2">
                <button type="button" class="btn btn-primary btn_big AddProduct">Agregar</button>

            </div>
        </div>



        <!--PRODUCTS WITH THEIR ATRIBUTES-->
        <div class="form-group row">
            <table class="table table-striped table-dark col-md-8 offset-md-2" id="ProducttableC">
                <thead>
                    <tr>
                        <th scope="col">Descripcion del Producto</th>
                        <th scope="col">Cantidad</th>
                        <th scope="col">Capacidad</th>
                        <th scope="col">Tipo de Contenedor</th>

                        <th scope="col">Manejo del Producto</th>
                    </tr>
                </thead>
                <tr class="participantRow">

                    <td>
                        <select class="form-control" id="ProductValC">
                            <option value="0">Por favor selecciona un Producto</option>

                            @{foreach (var item in Model.Products)
                                {
                                    <option value="@item.ProductID">@item.ProductName</option>
                                }
                            }
                        </select>
                    </td>
                    <td>
                        <input type="number" min="0" class="form-control" id="ProductQuantityValC" placeholder="Agregar la cantidad del Producto">
                    </td>

                    <td>
                        <input type="text" class="form-control" id="UnitValC" placeholder="Agregar la capacidad para el Contenedor">
                    </td>
                    <td>
                        <select class="form-control" id="ContainerValC">
                            <option value="0">Por favor selecciona un Contenedor</option>

                            @{foreach (var item in Model.Containers)
                                {
                                    <option value="@item.ContainerID">@item.ContainerName</option>
                                }
                            }
                        </select>
                    </td>
                    <td>
                        <select class="form-control" id="ManagementValC">
                            <option value="0">Por favor selecciona el manejo para el material</option>

                            @{foreach (var item in Model.ManagementsTypes)
                                {
                                    <option value="@item.ManagementID">@item.ManagementName</option>
                                }
                            }
                        </select>
                    </td>


                    <td>
                        <button class="btn btn-danger remove" type="button">Remove</button>
                    </td>
                </tr>
            </table>
        </div>



    </section>


    <!--BUTTON TO SAVE THE DOCUMENT-->
    <div class="form-group row">
        <div class="col-md-2 offset-md-2">
            <a class="btn btn-primary" asp-action="Status" asp-controller="Home">Back</a>
        </div>
        <div class="col-md-2 offset-md-5">
            <button style="text-align:right" class="btn btn-primary SaveDocumentC">Guardar Manifiesto</button>
        </div>
    </div>
</section>




@section Scripts
    {
    <script>
        class ProductRow {
            constructor(ProductID, ContainerID, ManagementID, Quantity, Unit) {
                this.ProductID = ProductID;
                this.ContainerID = ContainerID;
                this.ManagementID = ManagementID;
                this.Quantity = Quantity;
                this.Unit = Unit;
            }
        }
        /* Variables */

        var CompleteDrow = $(".participantRow");

        /* Functions */


        function addRowC() {
            CompleteDrow.clone(true, true).appendTo("#ProducttableC");
        }

        $('.AddProduct').on("click", function () {



            if ($("#ProducttableC tr").length < 17) {
                addRowC();

            }
            $(this).closest("tr").appendTo("#ProducttableC");



        });
        $("#ProducttableC").on('click', '.remove', function () {
            removeRow($(this));
           
        });
        function removeRow(button) {
            button.closest("tr").remove();
        }
        $('.SaveDocumentC').on("click", function () {

           

            var DocumentID = $('#ManifiestoValC').val();
          
            SaveDocumentJSC(DocumentID);
                 




        });

        function SaveDocumentJSC(DocumentID) {
            var ListProducts = [];
            var FlagError = 'NoError';
            var data = new FormData();
            data.append("DocumentID", DocumentID);
          

            

            $("#ProducttableC tbody tr").each(function (index) {


                var product = $($(this).children("td")[0]).children().val();
                var quantityProduct = $($(this).children("td")[1]).children().val();
                var capacity = $($(this).children("td")[2]).children().val();
                var typecontainer = $($(this).children("td")[3]).children().val();
                var productmag = $($(this).children("td")[4]).children().val();

                ValidateProducts(product, quantityProduct, typecontainer, productmag);

                var Prod = new ProductRow(product, typecontainer, productmag, quantityProduct, capacity);
                ListProducts.push(Prod);


            });

            var index = 0;
            for (var product of ListProducts) {

                data.append("ListProducts[" + index + "].ProductID", product.ProductID);
                data.append("ListProducts[" + index + "].ContainerID", product.ContainerID);
                data.append("ListProducts[" + index + "].ManagementID", product.ManagementID);
                data.append("ListProducts[" + index + "].Quantity", product.Quantity);
                data.append("ListProducts[" + index + "].Unit", product.Unit);
                index++;
            }
            


            //data.append("ListProducts", ListProducts);
            debugger;
            var url = '@Url.Action("AddDocumentC", "Status")';
            if (FlagError == 'NoError') {
                $.ajax({
                    url: url,
                    data: data,
                    //dataType: "JSON",
                    cache: false,
                    contentType: false,
                    processData: false,
                    assign: false,
                    method: "post",
                    success: function (r) {
                       
                        debugger;
                        if (r == "true") {
                            alert("Se completo el manifiesto con exito!");

                            let urlR = '@Url.Action("Status", "Home")';
                          
                           
                            window.location.href = urlR;
                        }
                        else {
                            alert("Hubo en error favor de verificar la informacion o inentarlo de nuevo");
                        }


                    },
                    error: function () {

                        alert("Error intente mas tarde");
                    }
                });
            }
          
        }

        function ValidateProducts(product, quantityProduct, typecontainer, productmag) {

            if (product == 0) {
                alert('Favor de agregar un Producto en la seccion de productos. (Verificar informacion)');
                exit();
            }
            else {
                if (quantityProduct == 0) {
                    alert('Favor de agregar la cantidad del Producto en la seccion de productos. (Verificar informacion)');
                    exit();
                }
                else {
                    if (typecontainer == 0) {
                        alert('Favor de agregar el contenedor para el producto en la seccion de productos. (Verificar informacion)');
                        exit();
                    }
                    else {
                        if (productmag == 0) {
                            alert('Favor de agregar el tipo de manejo para el Producto en la seccion de productos. (Verificar informacion)');
                            exit();
                        }

                    }
                }
            }




        }


        $('.DeleteProductsT').on("click", function () {

            $('.ProductRows').empty();



        });





        


        function MCreateTable(Product, ProductQuantity, Unit, Container , Management) {

            var table = "";
            table += "<tr>" +
                            "<td>" + Product + "</td>" +
                            "<td>" + ProductQuantity + "</td>" +
                            "<td>" + Unit  + "</td>" +
                            "<td>" + Container + "</td>" +
                            "<td>" + Management + "</td>" +
                        "<tr>";



            debugger;
            $(".ProductRows").append(table);



        }


    
    </script>

}